<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Dashboard</title>
    <style>
        /* --- Brutalist Theme --- */
        *, *::before, *::after {
            box-sizing: border-box; /* THE FIX: Prevents horizontal scroll */
        }
        body { 
            background-color: #ffffff; 
            color: #000000;
            font-family: 'Courier New', Courier, monospace;
            -webkit-font-smoothing: none;
            -moz-osx-font-smoothing: grayscale;
            padding: 1rem; /* Adjusted for mobile first */
        }

        /* --- Layout --- */
        .container {
            width: 100%;
            max-width: 42rem;
            margin: auto;
            border: 2px solid #000;
            padding: 1rem; /* Adjusted for mobile first */
        }
        .section {
            margin-bottom: 3rem;
        }
        hr {
            border: none;
            border-top: 2px solid #000;
            margin: 3rem 0;
        }

        /* --- Typography --- */
        h1 { font-size: 2rem; font-weight: bold; text-transform: uppercase; } /* Adjusted for mobile */
        h2 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem; text-transform: uppercase; } /* Adjusted for mobile */
        p { font-size: 1rem; color: #000; margin-top: 0.5rem; }
        label { display: block; font-size: 1rem; font-weight: bold; margin-bottom: 0.5rem; }
        .label-note { font-size: 0.8rem; color: #000; }

        /* --- Form Elements --- */
        .form-header { text-align: center; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        input[type="text"], input[type="password"], textarea, input[type="search"], input[type="file"], input[type="color"] {
            width: 100%;
            padding: 0.75rem;
            background-color: #fff;
            border: 2px solid #000;
            font-size: 1rem;
            color: #000;
            border-radius: 0;
            -webkit-appearance: none;
        }
        input[type="file"] { padding: 0.4rem; }
        input[type="color"] { padding: 0.1rem; height: 45px; }
        input:focus, textarea:focus {
            outline: 2px solid #0000ff;
            outline-offset: 2px;
        }
        textarea { resize: vertical; min-height: 150px; }
        .checkbox-group { display: flex; align-items: center; margin-top: 0.5rem; }
        .checkbox-group label { margin-left: 0.5rem; font-weight: normal; }
        
        /* Image Preview & Canvas */
        .image-preview-container { margin-top: 1rem; display: none; }
        #image-preview { max-width: 100%; border: 2px solid #000; }
        #drawing-canvas { border: 2px solid #000; cursor: crosshair; background-color: #fff; }
        .drawing-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; gap: 1rem; }
        
        /* --- Buttons --- */
        button {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-weight: bold;
            border: 2px solid #000;
            cursor: pointer;
            background-color: #fff;
            color: #000;
            border-radius: 0;
            text-transform: uppercase;
        }
        button:hover:not(:disabled) { background-color: #ffff00; }
        button:disabled { opacity: 0.5; cursor: not-allowed; background-color: #ccc; }
        .btn-primary, .btn-secondary, .btn-edit { width: auto; }
        .btn-primary { background-color: #ffff00; }
        .btn-primary:hover:not(:disabled) { background-color: #fff; }
        .button-group { display: flex; flex-direction: column; gap: 1rem; }

        /* --- Utilities & Components --- */
        .controls-container { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; }
        
        .posts-list { list-style: none; }
        .post-item { display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 2px solid #000; margin-bottom: 0.5rem; }
        .post-link { font-size: 1rem; color: #0000ff; text-decoration: underline; }
        
        .pagination-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; }
        
        .message-box { margin-top: 1.5rem; text-align: center; font-weight: bold; }
        .message-success { color: #008000; }
        .message-error { color: #ff0000; }
        .message-info { color: #0000ff; }

        .loader { display: none; } /* Loader removed for simplicity */
        .hidden { display: none; }

        /* ** NEW ** -- Media Query for Larger Screens */
        @media (min-width: 768px) {
            body {
                padding: 2rem 1rem;
            }
            .container {
                padding: 2rem;
            }
            h1 {
                font-size: 2.5rem;
            }
            h2 {
                font-size: 2rem;
            }
            .controls-container {
                flex-direction: row;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Posting Form Section -->
        <div id="form-section" class="section">
            <div class="form-header">
                <h1 id="form-title">Post Something</h1>
            </div>
            <form id="post-form">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" placeholder="Post Title (Optional)">
                </div>
                <div class="form-group">
                    <label for="content">Content</label>
                    <textarea id="content" required placeholder="Markdown content..."></textarea>
                </div>

                <div class="drawing-section">
                    <label>Draw Picture</label>
                    <canvas id="drawing-canvas"></canvas>
                    <div class="drawing-controls">
                        <div>
                            <label for="color-picker" style="font-size: 0.8rem; margin-bottom: 0.2rem;">Color</label>
                            <input type="color" id="color-picker" value="#000000">
                        </div>
                        <button type="button" id="clear-canvas-btn">Clear</button>
                    </div>
                </div>

                 <div class="form-group">
                    <label for="image">Or Upload Image</label>
                    <input type="file" id="image-input" accept="image/*">
                    <div class="image-preview-container" id="image-preview-container">
                        <img id="image-preview" src="#" alt="Image preview">
                    </div>
                </div>
                 <div class="form-group">
                    <label for="image-path-input">Image Path</label>
                    <input type="text" id="image-path-input" placeholder="/assets/img">
                </div>
                <div class="form-group">
                    <label for="image-shortcode-input">Shortcode Template</label>
                    <div class="label-note">Use IMAGE_NAME as placeholder</div>
                    <input type="text" id="image-shortcode-input" placeholder="{{< img src=`/img/IMAGE_NAME` >}}">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                    <div class="checkbox-group">
                        <input type="checkbox" id="save-password">
                        <label for="save-password">Save Password</label>
                    </div>
                </div>
                <div class="button-group">
                    <button type="submit" id="submit-button" class="btn-primary">
                        <span id="button-text">Push to GitHub</span>
                    </button>
                    <button type="button" id="cancel-edit-button" class="btn-secondary hidden">
                        Cancel Edit
                    </button>
                </div>
            </form>
            <div id="message-box" class="message-box"></div>
        </div>

        <hr>

        <!-- Previous Posts Section -->
        <div id="posts-section" class="section">
            <h2>Previous Posts</h2>
            <div class="controls-container">
                <input type="search" id="search-input" placeholder="Search..." style="flex-grow: 1;">
                <button id="sort-button">Sort: Newest</button>
            </div>
            <div>
                <ul id="posts-list" class="posts-list"></ul>
                <div id="posts-loader" class="message-box message-info"></div>
                <div id="posts-error" class="message-box message-error"></div>
            </div>
            <div id="pagination-controls" class="pagination-controls">
                 <button id="prev-button" class="btn-secondary">Prev</button>
                <span id="page-indicator"></span>
                <button id="next-button" class="btn-secondary">Next</button>
            </div>
        </div>
    </div>

    <script>
        // --- Element Selectors ---
        const form = document.getElementById('post-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const messageBox = document.getElementById('message-box');
        const titleInput = document.getElementById('title');
        const contentInput = document.getElementById('content');
        const passwordInput = document.getElementById('password');
        const savePasswordCheckbox = document.getElementById('save-password');
        const formTitle = document.getElementById('form-title');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const imageInput = document.getElementById('image-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const imagePathInput = document.getElementById('image-path-input');
        const imageShortcodeInput = document.getElementById('image-shortcode-input');
        const postsList = document.getElementById('posts-list');
        const postsLoader = document.getElementById('posts-loader');
        const postsError = document.getElementById('posts-error');
        const paginationControls = document.getElementById('pagination-controls');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const pageIndicator = document.getElementById('page-indicator');
        const searchInput = document.getElementById('search-input');
        const sortButton = document.getElementById('sort-button');
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('color-picker');
        const clearCanvasBtn = document.getElementById('clear-canvas-btn');

        // --- State Variables ---
        let currentPage = 1;
        let totalPages = 1;
        let allPostsCache = [];
        let editState = { path: null, sha: null };
        let currentSort = 'newest';
        let isDrawing = false;
        let hasDrawn = false;
        let lastX = 0;
        let lastY = 0;

        // --- Canvas Functions ---
        function resizeCanvas() {
            const savedDrawing = localStorage.getItem('savedCanvas');
            const containerWidth = canvas.parentElement.clientWidth;
            canvas.width = containerWidth;
            canvas.height = containerWidth * 0.5;
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (savedDrawing) {
                const img = new Image();
                img.onload = () => ctx.drawImage(img, 0, 0);
                img.src = savedDrawing;
            }
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.strokeStyle = colorPicker.value;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            [lastX, lastY] = [x, y];
            hasDrawn = true;
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            [lastX, lastY] = [(e.clientX || e.touches[0].clientX) - rect.left, (e.clientY || e.touches[0].clientY) - rect.top];
        }

        function saveCanvasState() {
            if (hasDrawn) {
                localStorage.setItem('savedCanvas', canvas.toDataURL());
            } else {
                localStorage.removeItem('savedCanvas');
            }
        }

        function loadCanvasState() {
            const savedImage = localStorage.getItem('savedCanvas');
            if (savedImage) {
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                    hasDrawn = true;
                };
                img.src = savedImage;
            }
        }

        function stopDrawing() { 
            isDrawing = false;
            saveCanvasState();
        }
        
        function clearCanvas() {
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            hasDrawn = false;
            localStorage.removeItem('savedCanvas');
        }

        // --- Main Functions ---
        function renderPosts() {
            const searchTerm = searchInput.value.toLowerCase();
            let filteredPosts = allPostsCache.filter(post => post.name.toLowerCase().includes(searchTerm));
            if (currentSort === 'newest') {
                filteredPosts.sort((a, b) => b.name.localeCompare(a.name));
            } else {
                filteredPosts.sort((a, b) => a.name.localeCompare(b.name));
            }
            const perPage = 20;
            totalPages = Math.ceil(filteredPosts.length / perPage);
            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const paginatedPosts = filteredPosts.slice(start, end);
            if (paginatedPosts.length === 0) {
                postsList.innerHTML = `<li style="text-align: center;">${allPostsCache.length === 0 ? 'No posts found.' : 'No posts match your search.'}</li>`;
            } else {
                 postsList.innerHTML = paginatedPosts.map(post => `
                    <li class="post-item">
                        <a href="${post.url}" target="_blank" rel="noopener noreferrer" class="post-link" title="${post.name}">${post.name}</a>
                        <button onclick="handleEditClick('${post.path}')" class="btn-edit">Edit</button>
                    </li>`).join('');
            }
            pageIndicator.textContent = `Page ${currentPage} of ${totalPages || 1}`;
            prevButton.disabled = currentPage <= 1;
            nextButton.disabled = currentPage >= totalPages;
            paginationControls.style.display = totalPages > 1 ? 'flex' : 'none';
        }
        
        async function fetchPosts() {
            postsLoader.textContent = 'Loading posts...';
            postsError.textContent = '';
            try {
                const response = await fetch('/api/get-posts');
                if (!response.ok) throw new Error('Failed to fetch posts from server.');
                const result = await response.json();
                allPostsCache = result.posts;
                currentPage = 1;
                renderPosts();
            } catch (error) {
                postsError.textContent = `Error: ${error.message}`;
            } finally {
                postsLoader.textContent = '';
            }
        }

        async function handleEditClick(path) {
            messageBox.textContent = 'Fetching post content...';
            messageBox.className = 'message-box message-info';
            form.scrollIntoView({ behavior: 'smooth' });
            try {
                const response = await fetch(`/api/get-post-content?path=${encodeURIComponent(path)}`);
                if (!response.ok) throw new Error('Could not fetch post content.');
                const result = await response.json();
                titleInput.value = result.title;
                contentInput.value = result.content;
                editState = { path: result.path, sha: result.sha };
                formTitle.textContent = 'Editing Post';
                buttonText.textContent = 'Update Post';
                cancelEditButton.classList.remove('hidden');
                messageBox.textContent = 'Editing. To change image, draw or select a new one.';
            } catch (error) {
                messageBox.textContent = `Error: ${error.message}`;
                messageBox.className = 'message-box message-error';
            }
        }
        
        function resetFormAndState() {
            form.reset();
            editState = { path: null, sha: null };
            formTitle.textContent = 'Post Something';
            buttonText.textContent = 'Push to GitHub';
            cancelEditButton.classList.add('hidden');
            imagePreviewContainer.style.display = 'none';
            clearCanvas();
            loadPassword();
            loadImagePath();
            loadShortcode();
        }
        
        function savePassword() {
            if (savePasswordCheckbox.checked) {
                localStorage.setItem('post_dashboard_password', passwordInput.value);
            } else {
                localStorage.removeItem('post_dashboard_password');
            }
        }

        function loadPassword() {
            const savedPassword = localStorage.getItem('post_dashboard_password');
            if (savedPassword) {
                passwordInput.value = savedPassword;
                savePasswordCheckbox.checked = true;
            }
        }

        function saveImagePath() { localStorage.setItem('post_dashboard_image_path', imagePathInput.value); }
        function loadImagePath() { imagePathInput.value = localStorage.getItem('post_dashboard_image_path') || '/assets/img'; }
        function saveShortcode() { localStorage.setItem('post_dashboard_shortcode', imageShortcodeInput.value); }
        function loadShortcode() { imageShortcodeInput.value = localStorage.getItem('post_dashboard_shortcode') || '{{< img src="/img/IMAGE_NAME" >}}'; }
        
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // --- Event Listeners ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            savePassword();
            saveImagePath();
            saveShortcode();
            messageBox.textContent = '';
            submitButton.disabled = true;
            buttonText.textContent = editState.sha ? 'Updating...' : 'Publishing...';

            let imageData = null;
            let imageName = null;

            try {
                if (hasDrawn) {
                    imageData = canvas.toDataURL('image/png');
                    imageName = `drawing-${Date.now()}.png`;
                } else if (imageInput.files[0]) {
                    imageData = await getBase64(imageInput.files[0]);
                    imageName = imageInput.files[0].name;
                }
            } catch (error) {
                messageBox.textContent = `Error: Could not read image file.`;
                messageBox.className = 'message-box message-error';
                submitButton.disabled = false;
                return;
            }
            
            try {
                let currentSha = editState.sha;
                let newShortcode = '';
                
                if (imageData) {
                    buttonText.textContent = 'Uploading image...';
                    const imageResponse = await fetch('/api/upload-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            password: passwordInput.value,
                            imageData,
                            imageName,
                            imagePath: imagePathInput.value
                        }),
                    });
                    const imageResult = await imageResponse.json();
                    if (!imageResponse.ok) throw new Error(imageResult.error || 'Image upload failed.');
                    messageBox.textContent = 'Image uploaded. Preparing post...';
                    newShortcode = imageShortcodeInput.value.replace('IMAGE_NAME', imageResult.uniqueImageName);
                    if (currentSha) {
                        await new Promise(resolve => setTimeout(resolve, 3000));
                        const shaResponse = await fetch(`/api/get-post-content?path=${encodeURIComponent(editState.path)}`);
                        const shaResult = await shaResponse.json();
                        if (!shaResponse.ok) throw new Error('Could not refetch post SHA after image upload.');
                        currentSha = shaResult.sha;
                    }
                }

                buttonText.textContent = currentSha ? 'Updating post...' : 'Publishing post...';
                const finalContent = newShortcode ? `${newShortcode}\n\n${contentInput.value}` : contentInput.value;

                const postResponse = await fetch('/api/create-post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: titleInput.value,
                        content: finalContent,
                        password: passwordInput.value,
                        client_iso_date: new Date().toISOString(),
                        sha: currentSha,
                        path: editState.path,
                    }),
                });
                
                const postResult = await postResponse.json();
                if (!postResponse.ok) throw new Error(postResult.error || 'An unknown error occurred.');

                messageBox.textContent = `Success! ${postResult.message}`;
                messageBox.className = 'message-box message-success';
                resetFormAndState();
                await fetchPosts();
            } catch (error) {
                messageBox.textContent = `Error: ${error.message}`;
                messageBox.className = 'message-box message-error';
            } finally {
                submitButton.disabled = false;
                buttonText.textContent = editState.sha ? 'Update Post' : 'Push to GitHub';
            }
        });
        
        imageInput.addEventListener('change', () => {
            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.setAttribute('src', e.target.result);
                    imagePreviewContainer.style.display = 'block';
                }
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                imagePreviewContainer.style.display = 'none';
            }
        });
        
        cancelEditButton.addEventListener('click', resetFormAndState);
        searchInput.addEventListener('input', () => { currentPage = 1; renderPosts(); });
        sortButton.addEventListener('click', () => {
            currentSort = currentSort === 'newest' ? 'az' : 'newest';
            sortButton.textContent = currentSort === 'newest' ? 'Sort: Newest' : 'Sort: A-Z';
            currentPage = 1;
            renderPosts();
        });
        prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPosts(); } });
        nextButton.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; renderPosts(); } });

        // --- Initial Load & Canvas Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPassword();
            loadImagePath();
            loadShortcode();
            fetchPosts();
            resizeCanvas();
            loadCanvasState();
        });
        window.addEventListener('resize', resizeCanvas);
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
        clearCanvasBtn.addEventListener('click', clearCanvas);
    </script>
</body>
</html>


