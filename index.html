<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Post Dashboard</title>
    <style>
        /* Minimal styling based on your preference */
        body { font-family: sans-serif; background-color: #121212; color: #e0e0e0; max-width: 800px; margin: 2rem auto; padding: 1rem; }
        h1, h2 { font-weight: 300; border-bottom: 1px solid #444; padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
        label { display: block; margin: 1rem 0 0.5rem; color: #aaa; }
        input, textarea, button { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border-radius: 6px; border: 1px solid #444; background-color: #222; color: #e0e0e0; font-size: 1rem; box-sizing: border-box; }
        textarea { min-height: 250px; }
        button { background-color: #3b82f6; cursor: pointer; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        #status { margin-top: 1rem; padding: 0.75rem; border-radius: 6px; background-color: #2a2a2a; word-break: break-word; }
        .post-list-item { padding: 1rem 0; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .post-list-item a { color: #e0e0e0; text-decoration: none; }
        .post-controls button { width: auto; padding: 0.5rem 1rem; margin-left: 0.5rem; }
        .filters, .pagination { display: flex; justify-content: space-between; align-items: center; margin: 1.5rem 0; }
        .filters input, .filters button, .pagination button { width: auto; }
        .checkbox-container { display: flex; align-items: center; margin-bottom: 1.5rem; }
        .checkbox-container input { width: auto; margin: 0 0.5rem 0 0; }
    </style>
</head>
<body>
    <h1>Dashboard</h1>
    <form id="postForm">
        <h2 id="form-title">Create New Post</h2>
        
        <label for="title">Title (Optional)</label>
        <input type="text" id="title" name="title">

        <label for="content">Content</label>
        <textarea id="content" name="content" required></textarea>

        <label for="image">Attach Image (Optional)</label>
        <input type="file" id="image" name="image" accept="image/*">

        <label for="imagePath">Image Upload Path (e.g., /assets/img)</label>
        <input type="text" id="imagePath" name="imagePath">
        
        <label for="imageShortcodeTemplate">Image Shortcode Template (use IMAGE_NAME)</label>
        <input type="text" id="imageShortcodeTemplate" name="imageShortcodeTemplate">

        <label for="password">Password</label>
        <input type="password" id="password" name="password" required>
        <div class="checkbox-container">
            <input type="checkbox" id="savePassword">
            <label for="savePassword">Save Password</label>
        </div>
        
        <button type="submit">Submit Post</button>
        <button type="button" id="cancelEdit" style="display:none; background-color: #555;">Cancel Edit</button>
    </form>

    <div id="status"></div>

    <h2>Previous Posts</h2>
    <div class="filters">
        <input type="search" id="search" placeholder="Search posts...">
        <button type="button" id="sort">Sort by: Newest</button>
    </div>
    <div id="posts-list"></div>
    <div class="pagination">
        <button id="prevPage" disabled>Previous</button>
        <span id="pageInfo">Page 1 of 1</span>
        <button id="nextPage" disabled>Next</button>
    </div>

    <script>
        const form = document.getElementById('postForm');
        const statusDiv = document.getElementById('status');
        const postsListDiv = document.getElementById('posts-list');
        const passwordInput = document.getElementById('password');
        const savePasswordCheckbox = document.getElementById('savePassword');
        const imagePathInput = document.getElementById('imagePath');
        const shortcodeTemplateInput = document.getElementById('imageShortcodeTemplate');
        const cancelEditBtn = document.getElementById('cancelEdit');
        
        let allPosts = [];
        let filteredPosts = [];
        let currentPage = 1;
        const postsPerPage = 20;
        let sortOrder = 'newest';

        function resetForm() {
            form.reset();
            document.getElementById('form-title').textContent = 'Create New Post';
            document.getElementById('image').value = '';
            delete form.dataset.sha;
            delete form.dataset.path;
            cancelEditBtn.style.display = 'none';
            // Restore saved settings
            passwordInput.value = localStorage.getItem('postDashboardPassword') || '';
            savePasswordCheckbox.checked = !!localStorage.getItem('postDashboardPassword');
            imagePathInput.value = localStorage.getItem('postDashboardImagePath') || '/assets/img';
            shortcodeTemplateInput.value = localStorage.getItem('postDashboardShortcode') || '{{< img src="/img/IMAGE_NAME" >}}';
        }
        
        cancelEditBtn.addEventListener('click', resetForm);

        async function fetchPosts() {
            try {
                statusDiv.textContent = 'Fetching posts...';
                const response = await fetch('/api/get-posts');
                if (!response.ok) throw new Error('Failed to fetch posts.');
                const data = await response.json();
                allPosts = data.posts;
                applyFiltersAndRender();
                statusDiv.textContent = 'Posts loaded.';
            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        function applyFiltersAndRender() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            filteredPosts = allPosts.filter(post => post.name.toLowerCase().includes(searchTerm));

            if (sortOrder === 'newest') {
                filteredPosts.sort((a, b) => b.name.localeCompare(a.name));
            } else { // 'a-z'
                filteredPosts.sort((a, b) => a.name.localeCompare(b.name));
            }
            currentPage = 1;
            renderPosts();
        }

        function renderPosts() {
            postsListDiv.innerHTML = '';
            const start = (currentPage - 1) * postsPerPage;
            const end = start + postsPerPage;
            const paginatedPosts = filteredPosts.slice(start, end);

            paginatedPosts.forEach(post => {
                const item = document.createElement('div');
                item.className = 'post-list-item';
                item.innerHTML = `
                    <a href="${post.html_url}" target="_blank">${post.name}</a>
                    <div class="post-controls">
                        <button class="edit-btn" data-path="${post.path}" data-sha="${post.sha}">Edit</button>
                    </div>
                `;
                postsListDiv.appendChild(item);
            });
            updatePaginationControls();
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredPosts.length / postsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }

        document.getElementById('prevPage').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPosts(); } });
        document.getElementById('nextPage').addEventListener('click', () => { const totalPages = Math.ceil(filteredPosts.length / postsPerPage); if (currentPage < totalPages) { currentPage++; renderPosts(); } });

        document.getElementById('search').addEventListener('input', applyFiltersAndRender);
        document.getElementById('sort').addEventListener('click', (e) => {
            sortOrder = sortOrder === 'newest' ? 'a-z' : 'newest';
            e.target.textContent = `Sort by: ${sortOrder === 'newest' ? 'Newest' : 'A-Z'}`;
            applyFiltersAndRender();
        });

        postsListDiv.addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-btn')) {
                const path = e.target.dataset.path;
                statusDiv.textContent = `Fetching content for ${path}...`;
                try {
                    const response = await fetch(`/api/get-post-content?path=${encodeURIComponent(path)}`);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);
                    
                    const frontmatterEnd = data.content.indexOf('---', 3);
                    const contentWithoutFrontmatter = frontmatterEnd !== -1 ? data.content.substring(frontmatterEnd + 3).trim() : data.content;
                    const titleMatch = data.content.match(/title:\s*"(.*?)"/);

                    document.getElementById('title').value = titleMatch ? titleMatch[1] : '';
                    document.getElementById('content').value = contentWithoutFrontmatter;
                    document.getElementById('form-title').textContent = `Editing: ${path.split('/').pop()}`;
                    
                    form.dataset.path = path;
                    form.dataset.sha = data.sha;

                    cancelEditBtn.style.display = 'inline-block';
                    window.scrollTo(0, 0);
                    statusDiv.textContent = `Now editing ${path.split('/').pop()}`;
                } catch (error) {
                    statusDiv.textContent = `Error: ${error.message}`;
                }
            }
        });
        
        async function handleSubmit(event) {
            event.preventDefault();
            const submitButton = form.querySelector('button[type="submit"]');
            statusDiv.textContent = 'Submitting...';
            submitButton.disabled = true;

            try {
                const title = document.getElementById('title').value;
                const content = document.getElementById('content').value;
                const password = document.getElementById('password').value;
                const imageFile = document.getElementById('image').files[0];
                const imagePath = document.getElementById('imagePath').value;
                const shortcodeTemplate = document.getElementById('imageShortcodeTemplate').value;

                let finalContent = content;
                let sha = form.dataset.sha;
                const path = form.dataset.path;

                if (imageFile) {
                    statusDiv.textContent = 'Uploading image...';
                    const reader = new FileReader();
                    const imageDataPromise = new Promise((resolve, reject) => {
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(imageFile);
                    });
                    const imageData = await imageDataPromise;

                    const imageResponse = await fetch('/api/upload-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password, imageData, imageName: imageFile.name, imagePath }),
                    });

                    const imageResult = await imageResponse.json();
                    if (!imageResponse.ok) throw new Error(`Image Upload Error: ${imageResult.error}`);
                    statusDiv.textContent = `Image uploaded successfully.`;
                    
                    const finalShortcode = shortcodeTemplate.replace('IMAGE_NAME', imageResult.uniqueImageName);
                    finalContent = `${finalShortcode}\n\n${content}`;

                    if (sha) {
                        statusDiv.textContent += ' Waiting for GitHub...';
                        await new Promise(resolve => setTimeout(resolve, 3000));
                        statusDiv.textContent = 'Refreshing post data...';
                        const refetchResponse = await fetch(`/api/get-post-content?path=${encodeURIComponent(path)}`);
                        const refetchResult = await refetchResponse.json();
                        if (!refetchResponse.ok) throw new Error(`Failed to refresh post data: ${refetchResult.error}`);
                        sha = refetchResult.sha; // Update sha to the latest version
                    }
                }

                statusDiv.textContent = sha ? 'Updating post...' : 'Creating post...';
                const postResponse = await fetch('/api/create-post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, content: finalContent, password, client_iso_date: new Date().toISOString(), sha, path }),
                });

                const postResult = await postResponse.json();
                if (!postResponse.ok) throw new Error(`Post Submission Error: ${postResult.error}`);

                statusDiv.textContent = postResult.message;
                resetForm();
                fetchPosts();

            } catch (error) {
                console.error('Submission failed:', error);
                statusDiv.textContent = `Error: ${error.message}`;
                // **THE BUG FIX:** If any error occurs during submission, we must fully
                // reset the form to prevent it from getting stuck in a broken "edit" state.
                // This solves the issue where the `sha` is lost but the form still tries to update.
                resetForm();
            } finally {
                submitButton.disabled = false;
            }
        }
        
        form.addEventListener('submit', handleSubmit);
        
        window.addEventListener('DOMContentLoaded', () => {
            resetForm(); // Use resetForm to load all initial settings
            fetchPosts();
        });

        savePasswordCheckbox.addEventListener('change', () => {
            if (savePasswordCheckbox.checked) {
                localStorage.setItem('postDashboardPassword', passwordInput.value);
            } else {
                localStorage.removeItem('postDashboardPassword');
            }
        });
        passwordInput.addEventListener('input', () => { if (savePasswordCheckbox.checked) { localStorage.setItem('postDashboardPassword', passwordInput.value); } });
        imagePathInput.addEventListener('input', () => { localStorage.setItem('postDashboardImagePath', imagePathInput.value); });
        shortcodeTemplateInput.addEventListener('input', () => { localStorage.setItem('postDashboardShortcode', shortcodeTemplateInput.value); });

    </script>
</body>
</html>


