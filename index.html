<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 py-12">
    <div class="w-full max-w-2xl mx-auto space-y-8">
        <!-- Posting Form Card -->
        <div id="form-card" class="bg-white rounded-xl shadow-lg p-8">
            <div class="mb-8 text-center">
                <h1 id="form-title" class="text-3xl font-bold text-gray-800">Post Something Today</h1>
                <p class="text-gray-500 mt-2">Create a new markdown file and push it to your GitHub repository.</p>
            </div>
            <form id="post-form">
                <div class="space-y-6">
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title (Optional)</label>
                        <input type="text" id="title" name="title"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Your post title">
                    </div>
                    <div>
                        <label for="content" class="block text-sm font-medium text-gray-700 mb-1">Content (Markdown)</label>
                        <textarea id="content" name="content" rows="10" required
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Write your content here..."></textarea>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password" name="password" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Enter the secret password">
                        <div class="mt-2 flex items-center">
                            <input type="checkbox" id="save-password" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="save-password" class="ml-2 block text-sm text-gray-900">Save Password</label>
                        </div>
                    </div>
                </div>
                <div class="mt-8 space-y-3">
                    <button type="submit" id="submit-button" class="w-full flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400">
                        <span id="button-text">Push to GitHub</span>
                        <div id="loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-5 w-5 ml-3 hidden"></div>
                    </button>
                    <button type="button" id="cancel-edit-button" class="w-full flex justify-center items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 hidden">
                        Cancel Edit
                    </button>
                </div>
            </form>
            <div id="message-box" class="mt-6 text-center text-sm"></div>
        </div>

        <!-- Previous Posts Card -->
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Previous Posts</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <input type="search" id="search-input" placeholder="Search posts..." class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <select id="sort-select" class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="newest">Sort by Newest</option>
                    <option value="az">Sort by A-Z</option>
                </select>
            </div>
            <div id="posts-container">
                <ul id="posts-list" class="space-y-4"></ul>
                <div id="posts-loader" class="text-center py-4"></div>
                <div id="posts-error" class="text-center py-4 text-red-600"></div>
            </div>
            <div id="pagination-controls" class="mt-6 flex justify-between items-center">
                 <button id="prev-button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">Previous</button>
                <span id="page-indicator" class="text-sm text-gray-600"></span>
                <button id="next-button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">Next</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const form = document.getElementById('post-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const loader = document.getElementById('loader');
        const messageBox = document.getElementById('message-box');
        const titleInput = document.getElementById('title');
        const contentInput = document.getElementById('content');
        const passwordInput = document.getElementById('password');
        const savePasswordCheckbox = document.getElementById('save-password');
        const formTitle = document.getElementById('form-title');
        const cancelEditButton = document.getElementById('cancel-edit-button');

        const postsList = document.getElementById('posts-list');
        const postsLoader = document.getElementById('posts-loader');
        const postsError = document.getElementById('posts-error');
        const paginationControls = document.getElementById('pagination-controls');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const pageIndicator = document.getElementById('page-indicator');
        const searchInput = document.getElementById('search-input');
        const sortSelect = document.getElementById('sort-select');

        // State
        let currentPage = 1;
        let totalPages = 1;
        let allPostsCache = [];
        let editState = { path: null, sha: null };

        // --- Post Rendering and Filtering ---
        function renderPosts() {
            const searchTerm = searchInput.value.toLowerCase();
            const sortBy = sortSelect.value;

            let filteredPosts = allPostsCache.filter(post => post.name.toLowerCase().includes(searchTerm));

            if (sortBy === 'newest') {
                filteredPosts.sort((a, b) => b.name.localeCompare(a.name));
            } else if (sortBy === 'az') {
                filteredPosts.sort((a, b) => a.name.localeCompare(b.name));
            }

            // Pagination logic on the filtered/sorted data
            const perPage = 20;
            totalPages = Math.ceil(filteredPosts.length / perPage);
            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const paginatedPosts = filteredPosts.slice(start, end);

            if (paginatedPosts.length === 0 && searchTerm) {
                postsList.innerHTML = `<li class="text-center text-gray-500">No posts match your search.</li>`;
            } else if (paginatedPosts.length === 0) {
                 postsList.innerHTML = `<li class="text-center text-gray-500">No posts found.</li>`;
            } else {
                 postsList.innerHTML = paginatedPosts.map(post => `
                    <li class="flex justify-between items-center border-b border-gray-200 pb-3">
                        <a href="${post.url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline truncate" title="${post.name}">
                            ${post.name}
                        </a>
                        <button onclick="handleEditClick('${post.path}')" class="ml-4 px-3 py-1 text-sm font-medium text-blue-700 bg-blue-100 border border-transparent rounded-lg hover:bg-blue-200">Edit</button>
                    </li>
                `).join('');
            }
           
            pageIndicator.textContent = `Page ${currentPage} of ${totalPages || 1}`;
            prevButton.disabled = currentPage <= 1;
            nextButton.disabled = currentPage >= totalPages;
            paginationControls.style.display = totalPages > 1 ? 'flex' : 'none';
        }
        
        // --- API Calls ---
        async function fetchPosts() {
            postsLoader.textContent = 'Loading posts...';
            postsError.textContent = '';
            
            try {
                // We fetch all posts at once and handle pagination/filtering on the client
                const response = await fetch(`/api/get-posts?page=1`); // Simplified to get all
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                
                // The current get-posts returns paginated data, so we'll just use the first page for now.
                // For full client-side search, the API should be modified to return all posts.
                // But for now, this will work for up to 20 posts.
                allPostsCache = result.posts;
                currentPage = 1; // Reset to page 1 on new fetch/filter
                renderPosts();
            } catch (error) {
                postsError.textContent = `Error: ${error.message}`;
            } finally {
                postsLoader.textContent = '';
            }
        }

        async function handleEditClick(path) {
            messageBox.textContent = 'Fetching post content...';
            messageBox.className = 'mt-6 text-center text-sm text-gray-600';
            form.scrollIntoView({ behavior: 'smooth' });

            try {
                const response = await fetch(`/api/get-post-content?path=${encodeURIComponent(path)}`);
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);

                titleInput.value = result.title;
                contentInput.value = result.content;
                editState = { path: result.path, sha: result.sha };

                formTitle.textContent = 'Editing Post';
                buttonText.textContent = 'Update Post';
                cancelEditButton.classList.remove('hidden');
                messageBox.textContent = '';
            } catch (error) {
                messageBox.textContent = `Error: ${error.message}`;
                messageBox.className = 'mt-6 text-center text-sm text-red-600';
            }
        }
        
        // --- Form and State Logic ---
        function resetFormAndState() {
            form.reset();
            editState = { path: null, sha: null };
            formTitle.textContent = 'Post Something Today';
            buttonText.textContent = 'Push to GitHub';
            cancelEditButton.classList.add('hidden');
            loadPassword(); // Reload password after reset
        }
        
        function savePassword() {
            if (savePasswordCheckbox.checked) {
                localStorage.setItem('post_dashboard_password', passwordInput.value);
            } else {
                localStorage.removeItem('post_dashboard_password');
            }
        }

        function loadPassword() {
            const savedPassword = localStorage.getItem('post_dashboard_password');
            if (savedPassword) {
                passwordInput.value = savedPassword;
                savePasswordCheckbox.checked = true;
            }
        }

        // --- Event Listeners ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            savePassword();

            messageBox.textContent = '';
            submitButton.disabled = true;
            buttonText.textContent = editState.sha ? 'Updating...' : 'Publishing...';
            loader.classList.remove('hidden');

            const data = {
                title: titleInput.value,
                content: contentInput.value,
                password: passwordInput.value,
                client_iso_date: new Date().toISOString(),
                sha: editState.sha, // Will be null if not editing
                path: editState.path  // Will be null if not editing
            };

            try {
                const response = await fetch('/api/create-post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);

                messageBox.textContent = `Success! ${result.message}`;
                messageBox.className = 'mt-6 text-center text-sm text-green-600';
                resetFormAndState();
                fetchPosts();
            } catch (error) {
                messageBox.textContent = `Error: ${error.message}`;
                messageBox.className = 'mt-6 text-center text-sm text-red-600';
            } finally {
                submitButton.disabled = false;
                loader.classList.add('hidden');
            }
        });
        
        cancelEditButton.addEventListener('click', resetFormAndState);
        searchInput.addEventListener('input', () => { currentPage=1; renderPosts(); });
        sortSelect.addEventListener('change', () => { currentPage=1; renderPosts(); });
        
        prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPosts(); } });
        nextButton.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; renderPosts(); } });

        document.addEventListener('DOMContentLoaded', () => {
            loadPassword();
            fetchPosts();
        });
    </script>
</body>
</html>

