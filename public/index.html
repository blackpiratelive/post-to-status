<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Post Dashboard</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior-y: none;
            color: #111;
            background: #fff;
            margin: 0;
            padding: 16px;
            line-height: 1.4;
        }
        .container {
            max-width: 760px;
            margin: 0 auto;
        }
        h1 {
            font-size: 28px;
            margin: 0 0 12px;
        }
        h2 {
            font-size: 18px;
            margin: 0 0 8px;
        }
        .panel {
            border: 1px solid #ddd;
            padding: 12px;
            margin-bottom: 16px;
        }
        .field {
            margin-bottom: 12px;
        }
        .field:last-child {
            margin-bottom: 0;
        }
        label {
            font-size: 12px;
            color: #444;
            display: block;
            margin-bottom: 4px;
        }
        input[type="text"],
        input[type="password"],
        input[type="search"],
        textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
        }
        textarea {
            resize: vertical;
        }
        button {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #bbb;
            background: #f5f5f5;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #eee;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .button-group button {
            width: 100%;
        }
        .button-group button + button {
            margin-top: 8px;
        }
        #attachment-preview {
            max-width: 100%;
            height: auto;
            display: block;
            margin-bottom: 8px;
        }
        #attachment-preview-container {
            position: relative;
        }
        #clear-attachment-button {
            position: absolute;
            top: 6px;
            right: 6px;
            border: none;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            border-radius: 999px;
            padding: 4px 6px;
            cursor: pointer;
        }
        #posts-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #posts-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-top: 1px solid #eee;
        }
        #posts-list li:first-child {
            border-top: none;
        }
        #pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        #message-box,
        #posts-loader,
        #posts-error {
            text-align: center;
            font-size: 12px;
            margin-top: 8px;
        }
        #posts-loader {
            color: #666;
        }
        #posts-error {
            color: #c00;
        }
        #message-box.info {
            color: #555;
        }
        #message-box.success {
            color: #0a7;
        }
        #message-box.error {
            color: #c00;
        }
        .mode-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .inline-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #444;
        }
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>New Note</h1>
        </header>

        <!-- Main Form Section -->
        <main id="form-section">
            <!-- Content and Title Form -->
            <div class="panel">
                <form id="post-form">
                    <div class="mode-row">
                        <strong>Mode</strong>
                        <label class="inline-label" for="raw-toggle">
                            <input type="checkbox" id="raw-toggle">
                            Raw mode
                        </label>
                    </div>
                    <div id="editor-fields">
                        <div class="field">
                            <input type="text" id="title" placeholder="Title">
                        </div>
                        <div class="field">
                            <textarea id="content" required placeholder="Start writing..." rows="8"></textarea>
                        </div>
                    </div>
                    <div id="raw-view" class="hidden">
                        <textarea id="raw-output" readonly spellcheck="false" rows="10"></textarea>
                    </div>
                </form>
            </div>

            <!-- Tags Section -->
            <div class="panel">
                <div class="field">
                    <label>Tags</label>
                    <div class="tag-list">
                        <label class="inline-label"><input type="checkbox" name="tags" value="website">website</label>
                        <label class="inline-label"><input type="checkbox" name="tags" value="quotes">quotes</label>
                        <label class="inline-label"><input type="checkbox" name="tags" value="articles">articles</label>
                        <label class="inline-label"><input type="checkbox" name="tags" value="bookmarks">bookmarks</label>
                        <label class="inline-label"><input type="checkbox" name="tags" value="study">study</label>
                    </div>
                </div>
                <div class="field">
                    <label for="custom-tags">Custom tags (comma-separated)</label>
                    <input type="text" id="custom-tags" placeholder="example, another-tag">
                </div>
            </div>

            <!-- Attachments Section -->
            <div class="panel">
                 <!-- This is where the image preview will appear -->
                <div id="attachment-preview-container" class="hidden">
                    <img id="attachment-preview" src="#" alt="Attachment preview">
                    <button id="clear-attachment-button" type="button" aria-label="Clear attachment">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div id="attachment-buttons">
                    <label for="image-input">
                        Upload Image
                        <input type="file" id="image-input" accept="image/*">
                    </label>
                </div>
            </div>

            <!-- Settings & Password Section -->
            <div class="panel">
                <div class="field">
                    <label for="image-path-input">Image Path</label>
                    <input type="text" id="image-path-input">
                </div>
                <div class="field">
                    <label for="image-shortcode-input">Shortcode Template (use IMAGE_NAME)</label>
                    <input type="text" id="image-shortcode-input">
                </div>
                <div class="field">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <div class="inline-label">
                    <input type="checkbox" id="save-password">
                    <label for="save-password">Save Password</label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <button type="submit" id="submit-button" form="post-form">
                    <span id="button-text">Save Note</span>
                </button>
                <button type="button" id="cancel-edit-button" class="hidden">Cancel Edit</button>
            </div>
            <div id="message-box"></div>
        </main>

        <!-- Previous Posts Section -->
        <section id="posts-section">
            <h2>Previous Notes</h2>
            <div class="panel">
                 <div class="field">
                    <input type="search" id="search-input" placeholder="Search notes...">
                </div>
                <div>
                    <ul id="posts-list"></ul>
                    <div id="posts-loader"></div>
                    <div id="posts-error"></div>
                </div>
                <div id="pagination-controls" class="hidden">
                    <button id="prev-button">Previous</button>
                    <span id="page-indicator"></span>
                    <button id="next-button">Next</button>
                </div>
            </div>
        </section>
    </div>

    <script>
        // --- Element Selectors ---
        const form = document.getElementById('post-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const messageBox = document.getElementById('message-box');
        const titleInput = document.getElementById('title');
        const contentInput = document.getElementById('content');
        const passwordInput = document.getElementById('password');
        const savePasswordCheckbox = document.getElementById('save-password');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const imageInput = document.getElementById('image-input');
        const imagePathInput = document.getElementById('image-path-input');
        const imageShortcodeInput = document.getElementById('image-shortcode-input');
        const postsList = document.getElementById('posts-list');
        const postsLoader = document.getElementById('posts-loader');
        const postsError = document.getElementById('posts-error');
        const searchInput = document.getElementById('search-input');
        const rawToggle = document.getElementById('raw-toggle');
        const editorFields = document.getElementById('editor-fields');
        const rawView = document.getElementById('raw-view');
        const rawOutput = document.getElementById('raw-output');
        const tagCheckboxes = document.querySelectorAll('input[name="tags"]');
        const customTagsInput = document.getElementById('custom-tags');
        
        // Attachment Previews
        const attachmentPreviewContainer = document.getElementById('attachment-preview-container');
        const attachmentPreview = document.getElementById('attachment-preview');
        const clearAttachmentButton = document.getElementById('clear-attachment-button');
        const attachmentButtons = document.getElementById('attachment-buttons');

        // Pagination
        const paginationControls = document.getElementById('pagination-controls');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const pageIndicator = document.getElementById('page-indicator');

        // --- State Variables ---
        let allPostsCache = [];
        let editState = { path: null, sha: null };
        let currentAttachment = null; // Can be 'file'
        let pendingImageName = null;
        let currentPage = 1;
        const postsPerPage = 10;
        let totalPages = 1;

        function slugify(text) {
            if (!text) return 'untitled';
            return text
                .toString()
                .toLowerCase()
                .trim()
                .replace(/\s+/g, '-')
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .substring(0, 50);
        }

        function getIstIsoString() {
            const now = new Date();
            const istOffsetMilliseconds = 330 * 60 * 1000;
            const istDate = new Date(now.getTime() + istOffsetMilliseconds);
            const year = istDate.getUTCFullYear();
            const month = String(istDate.getUTCMonth() + 1).padStart(2, '0');
            const day = String(istDate.getUTCDate()).padStart(2, '0');
            const hours = String(istDate.getUTCHours()).padStart(2, '0');
            const minutes = String(istDate.getUTCMinutes()).padStart(2, '0');
            const seconds = String(istDate.getUTCSeconds()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}+05:30`;
        }

        function buildUniqueImageName(originalName) {
            if (!originalName) return null;
            const parts = originalName.split('.');
            const extension = parts.length > 1 ? parts.pop().toLowerCase() : 'png';
            const base = parts.join('.');
            const safeBase = slugify(base);
            return `${Date.now()}-${safeBase}.${extension}`;
        }

        function formatTagsForFrontmatter(tags) {
            if (!tags.length) return '';
            const quotedTags = tags.map(tag => JSON.stringify(tag));
            return `tags: [${quotedTags.join(', ')}]\n`;
        }

        function getSelectedTags() {
            const checked = Array.from(tagCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
            const custom = customTagsInput.value
                .split(',')
                .map(tag => tag.trim())
                .filter(Boolean);
            const merged = [...checked, ...custom];
            const seen = new Set();
            return merged.filter(tag => {
                const key = tag.toLowerCase();
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        function setSelectedTags(tags) {
            const normalized = tags.map(tag => tag.trim()).filter(Boolean);
            const normalizedSet = new Set(normalized.map(tag => tag.toLowerCase()));
            const presetSet = new Set(Array.from(tagCheckboxes).map(checkbox => checkbox.value.toLowerCase()));
            tagCheckboxes.forEach(checkbox => {
                checkbox.checked = normalizedSet.has(checkbox.value.toLowerCase());
            });
            const custom = normalized.filter(tag => !presetSet.has(tag.toLowerCase()));
            customTagsInput.value = custom.join(', ');
        }

        function parseTagsFromFrontmatter(frontmatter) {
            const lines = frontmatter.split('\n').map(line => line.trim());
            for (let i = 0; i < lines.length; i++) {
                if (!lines[i].startsWith('tags:')) continue;
                const rest = lines[i].slice(5).trim();
                if (rest.startsWith('[')) {
                    const inner = rest.replace(/^\[/, '').replace(/\]$/, '');
                    if (!inner.trim()) return [];
                    return inner.split(',').map(tag => tag.trim()).map(tag => tag.replace(/^["']|["']$/g, '')).filter(Boolean);
                }
                const tags = [];
                for (let j = i + 1; j < lines.length; j++) {
                    if (!lines[j].startsWith('-')) break;
                    const tag = lines[j].replace(/^-/, '').trim().replace(/^["']|["']$/g, '');
                    if (tag) tags.push(tag);
                }
                return tags;
            }
            return [];
        }

        function buildRawPreview() {
            const title = titleInput.value || '';
            const postDateISO = editState.path ? new Date().toISOString() : getIstIsoString();
            let content = contentInput.value || '';
            if (currentAttachment === 'file' && pendingImageName) {
                const shortcode = imageShortcodeInput.value.replace('IMAGE_NAME', pendingImageName);
                content = `${shortcode}\n\n${content}`;
            }
            const tagsLine = formatTagsForFrontmatter(getSelectedTags());
            return `---\ntitle: "${title}"\n${tagsLine}date: "${postDateISO}"\n---\n\n${content}`;
        }

        function updateRawOutput() {
            rawOutput.value = buildRawPreview();
        }

        // --- Attachment & Preview Functions ---
        function showAttachmentPreview(src) {
            currentAttachment = 'file';
            attachmentPreview.src = src;
            attachmentPreviewContainer.classList.remove('hidden');
            attachmentButtons.classList.add('hidden');
            updateRawOutput();
        }

        function clearAttachment() {
            attachmentPreview.src = '#';
            attachmentPreviewContainer.classList.add('hidden');
            attachmentButtons.classList.remove('hidden');
            imageInput.value = ''; // Clear file input
            currentAttachment = null;
            pendingImageName = null;
            updateRawOutput();
        }

        // --- Main API & Form Functions ---
        function renderPosts() {
            const searchTerm = searchInput.value.toLowerCase();
            let filteredPosts = allPostsCache.filter(post => post.name.toLowerCase().includes(searchTerm));
            filteredPosts.sort((a, b) => b.name.localeCompare(a.name));
            
            totalPages = Math.ceil(filteredPosts.length / postsPerPage);
            if (currentPage > totalPages) currentPage = totalPages > 0 ? totalPages : 1;
            const start = (currentPage - 1) * postsPerPage;
            const end = start + postsPerPage;
            const paginatedPosts = filteredPosts.slice(start, end);

            if (paginatedPosts.length === 0) {
                postsList.innerHTML = `<li>${allPostsCache.length === 0 ? 'No notes found.' : 'No notes match your search.'}</li>`;
            } else {
                 postsList.innerHTML = paginatedPosts.map(post => `
                    <li>
                        <a href="${post.url}" target="_blank" rel="noopener noreferrer" title="${post.name}">${post.name}</a>
                        <button onclick="handleEditClick('${post.path}')">Edit</button>
                    </li>`).join('');
            }

            if (totalPages > 1) {
                paginationControls.classList.remove('hidden');
                pageIndicator.textContent = `Page ${currentPage} of ${totalPages}`;
                prevButton.disabled = currentPage === 1;
                nextButton.disabled = currentPage === totalPages;
            } else {
                paginationControls.classList.add('hidden');
            }
        }
        
        async function fetchPosts() {
            postsLoader.textContent = 'Loading notes...';
            postsError.textContent = '';
            try {
                const response = await fetch('/api/get-posts');
                if (!response.ok) throw new Error('Failed to fetch notes from server.');
                const result = await response.json();
                allPostsCache = result.posts;
                currentPage = 1;
                renderPosts();
            } catch (error) {
                postsError.textContent = `Error: ${error.message}`;
            } finally {
                postsLoader.textContent = '';
            }
        }

        async function handleEditClick(path) {
            messageBox.textContent = 'Fetching note...';
            messageBox.className = 'info';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            const response = await fetch(`/api/get-post-content?path=${encodeURIComponent(path)}`);
            const responseText = await response.text();
            
            if (!response.ok) {
                messageBox.textContent = `Error: ${responseText}`;
                messageBox.className = 'error';
                return;
            }

            try {
                const result = JSON.parse(responseText);
                const contentParts = result.content.split('---');
                const frontmatter = contentParts[1] || '';
                const mainContent = contentParts.slice(2).join('---').trim();
                const titleMatch = frontmatter.match(/title:\s*"(.*?)"/);

                titleInput.value = titleMatch ? titleMatch[1] : '';
                setSelectedTags(parseTagsFromFrontmatter(frontmatter));
                contentInput.value = mainContent;
                editState = { path: path, sha: result.sha };
                
                document.querySelector('h1').textContent = 'Editing Note';
                buttonText.textContent = 'Update Note';
                cancelEditButton.classList.remove('hidden');
                messageBox.textContent = 'Editing note. To change image, add a new one.';
                messageBox.className = 'info';
                clearAttachment(); // Clear any existing attachments when editing
                updateRawOutput();
            } catch (error) {
                 messageBox.textContent = `Error parsing post content: ${error.message}`;
                 messageBox.className = 'error';
            }
        }
        
        function resetFormAndState() {
            form.reset();
            editState = { path: null, sha: null };
            document.querySelector('h1').textContent = 'New Note';
            buttonText.textContent = 'Save Note';
            cancelEditButton.classList.add('hidden');
            clearAttachment();
            setSelectedTags([]);
            loadPassword();
            loadImagePath();
            loadShortcode();
            updateRawOutput();
        }
        
        function savePassword() {
            if (savePasswordCheckbox.checked) localStorage.setItem('post_dashboard_password', passwordInput.value);
            else localStorage.removeItem('post_dashboard_password');
        }

        function loadPassword() {
            const savedPassword = localStorage.getItem('post_dashboard_password');
            if (savedPassword) {
                passwordInput.value = savedPassword;
                savePasswordCheckbox.checked = true;
            }
        }

        function saveImagePath() { localStorage.setItem('post_dashboard_image_path', imagePathInput.value); }
        function loadImagePath() { imagePathInput.value = localStorage.getItem('post_dashboard_image_path') || 'assets/img'; }
        function saveShortcode() { localStorage.setItem('post_dashboard_shortcode', imageShortcodeInput.value); }
        function loadShortcode() {
            imageShortcodeInput.value = localStorage.getItem('post_dashboard_shortcode') || '{{< img src="/img/IMAGE_NAME" >}}';
            updateRawOutput();
        }
        
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        async function handleFormSubmit(e) {
            e.preventDefault();
            savePassword();
            saveImagePath();
            saveShortcode();
            messageBox.textContent = '';
            submitButton.disabled = true;
            buttonText.textContent = editState.sha ? 'Updating...' : 'Saving...';

            let imageData = null;
            let imageName = null;

            try {
                if (currentAttachment === 'file' && imageInput.files[0]) {
                    imageData = await getBase64(imageInput.files[0]);
                    imageName = imageInput.files[0].name;
                }
            } catch (error) {
                messageBox.textContent = `Error: Could not read image file.`;
                messageBox.className = 'error';
                submitButton.disabled = false;
                buttonText.textContent = editState.sha ? 'Update Note' : 'Save Note';
                return;
            }
            
            let finalResult;
            try {
                let currentSha = editState.sha;
                let newShortcode = '';
                
                if (imageData && imageName) {
                    buttonText.textContent = 'Uploading image...';
                    const imageResponse = await fetch('/api/upload-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            password: passwordInput.value,
                            imageData,
                            imageName,
                            imagePath: imagePathInput.value,
                            uniqueImageName: pendingImageName
                        }),
                    });
                    const imageResultText = await imageResponse.text();
                    if (!imageResponse.ok) throw new Error(`Image upload failed: ${imageResultText}`);
                    const imageResult = JSON.parse(imageResultText);

                    pendingImageName = imageResult.uniqueImageName;
                    updateRawOutput();
                    newShortcode = imageShortcodeInput.value.replace('IMAGE_NAME', imageResult.uniqueImageName);
                    
                    if (currentSha) {
                        await new Promise(resolve => setTimeout(resolve, 3000));
                        const shaResponse = await fetch(`/api/get-post-content?path=${encodeURIComponent(editState.path)}`);
                        if (!shaResponse.ok) throw new Error('Could not refetch post SHA after image upload.');
                        const shaResult = await shaResponse.json();
                        currentSha = shaResult.sha;
                    }
                }

                buttonText.textContent = currentSha ? 'Updating note...' : 'Saving note...';
                const finalContent = newShortcode ? `${newShortcode}\n\n${contentInput.value}` : contentInput.value;
                const tags = getSelectedTags();

                const postResponse = await fetch('/api/create-post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: titleInput.value,
                        content: finalContent,
                        tags: tags,
                        password: passwordInput.value,
                        client_iso_date: new Date().toISOString(),
                        sha: currentSha,
                        path: editState.path,
                    }),
                });
                
                const postResultText = await postResponse.text();
                if (!postResponse.ok) throw new Error(`Post creation failed. Server responded with: ${postResultText}`);
                finalResult = JSON.parse(postResultText);

                messageBox.textContent = `Success! ${finalResult.message}`;
                messageBox.className = 'success';
                resetFormAndState();
                await fetchPosts();
            } catch (error) {
                messageBox.textContent = `Error: ${error.message}`;
                messageBox.className = 'error';
            } finally {
                submitButton.disabled = false;
                buttonText.textContent = editState.sha ? 'Update Note' : 'Save Note';
            }
        }
        
        // --- Event Listeners ---
        form.addEventListener('submit', handleFormSubmit);
        cancelEditButton.addEventListener('click', resetFormAndState);
        rawToggle.addEventListener('change', () => {
            const showRaw = rawToggle.checked;
            editorFields.classList.toggle('hidden', showRaw);
            rawView.classList.toggle('hidden', !showRaw);
            updateRawOutput();
        });
        titleInput.addEventListener('input', updateRawOutput);
        contentInput.addEventListener('input', updateRawOutput);
        imageShortcodeInput.addEventListener('input', updateRawOutput);
        tagCheckboxes.forEach(checkbox => checkbox.addEventListener('change', updateRawOutput));
        customTagsInput.addEventListener('input', updateRawOutput);
        searchInput.addEventListener('input', () => {
            currentPage = 1;
            renderPosts();
        });

        // Attachment Listeners
        clearAttachmentButton.addEventListener('click', clearAttachment);
        imageInput.addEventListener('change', async (e) => {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                pendingImageName = buildUniqueImageName(file.name);
                const dataUrl = await getBase64(file);
                showAttachmentPreview(dataUrl);
            } else {
                clearAttachment();
            }
        });

        // Pagination Listeners
        prevButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderPosts();
            }
        });
        nextButton.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderPosts();
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPassword();
            loadImagePath();
            loadShortcode();
            fetchPosts();
        });
    </script>
</body>
</html>
